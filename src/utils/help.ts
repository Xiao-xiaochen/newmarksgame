import { Context, Session } from 'koishi'

// å®šä¹‰æŒ‡ä»¤åˆ†ç±»å’Œå¯¹åº”çš„æŒ‡ä»¤åˆ—è¡¨
const commandCategories = [
  {
    name: 'ä¸–ç•Œä¸åœ°å›¾',
    commands: [
      { name: 'æŸ¥çœ‹ä¸–ç•Œåœ°å›¾', desc: 'æŸ¥çœ‹ä¸–ç•Œåœ°å›¾æ¦‚è§ˆ' },
      { name: 'æŸ¥çœ‹åœ°åŒº', desc: 'æŸ¥çœ‹æŒ‡å®šåœ°åŒºæˆ–å½“å‰ç»‘å®šåœ°åŒºçš„è¯¦ç»†ä¿¡æ¯' },
      { name: 'æŸ¥çœ‹åœ°åŒºç‰¹è´¨', desc: 'æŸ¥çœ‹åœ°åŒºçš„ç‰¹æ®Šå±æ€§' },
      { name: 'æŸ¥çœ‹åœ°åŒºèµ„æºå‚¨é‡', desc: 'æŸ¥çœ‹åœ°åŒºçš„è‡ªç„¶èµ„æºå‚¨é‡' },
    ]
  },
  {
    name: 'ä¸ªäººä¸çŠ¶æ€',
    commands: [
      { name: 'é˜…è¯»æŠ¥å‘Š', alias: 'ç­¾åˆ°', desc: 'æ¯æ—¥ç­¾åˆ°/é˜…è¯»ä¸ªäººæŠ¥å‘Š' },
      { name: 'æˆ‘çš„å…¨éƒ¨èµ„æ–™', desc: 'æŸ¥çœ‹ä½ çš„æ‰€æœ‰ä¸ªäººä¿¡æ¯' },
      { name: 'æˆ‘çš„äººå£', desc: 'æŸ¥çœ‹ä½ æ§åˆ¶çš„äººå£ä¿¡æ¯ (è‹¥é€‚ç”¨)' },
      { name: 'æˆ‘çš„ä»“åº“', desc: 'æŸ¥çœ‹ä½ çš„ä¸ªäººç”Ÿæ´»/å·¥ä¸šä»“åº“ä¿¡æ¯' },
      { name: 'æˆ‘çš„å†›äº‹ä»“åº“', desc: 'æŸ¥çœ‹ä½ çš„ä¸ªäººå†›äº‹ä»“åº“ä¿¡æ¯' },
      { name: 'é©»æ‰', desc: 'é©»æ‰åˆ°å½“å‰ç¾¤èŠç»‘å®šçš„åœ°åŒº' },
    ]
  },
  {
    name: 'å›½å®¶ç®¡ç†',
    commands: [
      { name: 'ç»„å»ºå›½å®¶', desc: 'å»ºç«‹ä¸€ä¸ªæ–°çš„å›½å®¶' },
      { name: 'æˆ‘çš„å›½å®¶', desc: 'æŸ¥çœ‹ä½ æ‰€åœ¨å›½å®¶çš„ä¿¡æ¯' },
      { name: 'ä»–çš„å›½å®¶', desc: 'æŸ¥è¯¢æŒ‡å®šç©å®¶çš„å›½å®¶ä¿¡æ¯' },
      { name: 'å›½å®¶åœ°åŒºåˆ—è¡¨', desc: 'æŸ¥çœ‹æœ¬å›½æ§åˆ¶çš„æ‰€æœ‰åœ°åŒº (ä»…é™æˆå‘˜)' },
      { name: 'å›½å®¶æˆå‘˜åˆ—è¡¨', desc: 'æŸ¥çœ‹æœ¬å›½æ‰€æœ‰æˆå‘˜ (ä»…é™é¢†è¢–)' },
      { name: 'é‚€è¯·åŠ å…¥å›½å®¶', desc: 'é‚€è¯·ç©å®¶åŠ å…¥ä½ çš„å›½å®¶ (ä»…é™é¢†è¢–)' },
      { name: 'æ¥å—é‚€è¯·', desc: 'æ¥å—æ¥è‡ªæŸä¸ªå›½å®¶çš„é‚€è¯·' },
      { name: 'æ‹’ç»é‚€è¯·', desc: 'æ‹’ç»å½“å‰çš„å›½å®¶é‚€è¯·' },
      { name: 'å®£å¸ƒç‹¬ç«‹', desc: 'ç¦»å¼€ä½ å½“å‰æ‰€åœ¨çš„å›½å®¶ (é¢†è¢–æ— æ³•é€€å‡º)' },
      { name: 'ä¿®æ”¹å›½å®¶åç§°', desc: 'å›½å®¶é¢†å¯¼äººä¿®æ”¹è‡ªå·±å›½å®¶çš„åç§°' },
      { name: 'è§£æ•£å›½å®¶', desc: 'è§£æ•£ä½ é¢†å¯¼çš„å›½å®¶ (ä»…é™é¢†è¢–)' },
    ]
  },
  {
    name: 'åœ°åŒºç®¡ç†ä¸å»ºè®¾',
    commands: [
      { name: 'ç»‘å®šåœ°åŒº', desc: 'å°†æŒ‡å®šåœ°åŒºä¸å½“å‰ç¾¤èŠç»‘å®š (ä»…é™é¢†è¢–)' },
      { name: 'è§£ç»‘åœ°åŒº', desc: 'è§£é™¤å½“å‰ç¾¤èŠç»‘å®šçš„åœ°åŒº (ä»…é™é¢†è¢–)' },
      { name: 'æŸ¥çœ‹åœ°åŒºäººå£', desc: 'æŸ¥çœ‹åœ°åŒºçš„äººå£è¯¦æƒ…' },
      { name: 'æŸ¥çœ‹åœ°åŒºåŠ³åŠ¨åŠ›', desc: 'æŸ¥çœ‹åœ°åŒºçš„åŠ³åŠ¨åŠ›åˆ†é…æƒ…å†µ' },
      { name: 'æŸ¥çœ‹åœ°åŒºä»“åº“', desc: 'æŸ¥çœ‹åœ°åŒºçš„ç”Ÿæ´»/å·¥ä¸šä»“åº“' },
      { name: 'æŸ¥çœ‹åœ°åŒºå†›äº‹ä»“åº“', desc: 'æŸ¥çœ‹åœ°åŒºçš„å†›äº‹ä»“åº“' },
      { name: 'åœ°åŒºåˆ†é…åŠ³åŠ¨åŠ›', desc: 'åˆ†é…åœ°åŒºç©ºé—²åŠ³åŠ¨åŠ›åˆ°ç”Ÿäº§å»ºç­‘' },
      { name: 'åœ°åŒºå»ºé€ ', desc: 'åœ¨åœ°åŒºå¼€å§‹æ–°çš„å»ºç­‘é¡¹ç›®' },
    ]
  },
  {
    name: 'ç”Ÿäº§ä¸èµ„æº',
    commands: [
      { name: 'é˜…è¯»åœ°åŒºå†œä¸šæŠ¥å‘Š', desc: 'æŸ¥çœ‹åœ°åŒºçš„å†œä¸šäº§å‡ºæŠ¥å‘Š' },
      { name: 'æŸ¥çœ‹åœ°åŒºç¬¬äºŒäº§ä¸š', desc: 'æŸ¥çœ‹åœ°åŒºçš„å·¥ä¸šç”Ÿäº§æ¦‚å†µ' },
      { name: 'åœ°åŒºå¼€é‡‡', desc: 'åˆ†é…åœ°åŒºçŸ¿åœºè¿›è¡Œèµ„æºå¼€é‡‡' },
      { name: 'åœ°åŒºç‚¼é’¢', desc: 'ä½¿ç”¨åœ°åŒºç‚¼é’¢å‚è¿›è¡Œä¸€æ¬¡æ€§ç‚¼é’¢' },
      { name: 'åœ°åŒºç²¾ç‚¼', desc: 'ä½¿ç”¨åœ°åŒºç‚¼æ²¹å‚è¿›è¡Œä¸€æ¬¡æ€§ç²¾ç‚¼' },
      { name: 'åœ°åŒºå†›äº‹ç”Ÿäº§', desc: 'åœ¨åœ°åŒºç”Ÿäº§å†›äº‹å•ä½æˆ–è£…å¤‡' },
    ]
  },
  {
    name: 'ç®¡ç†å‘˜æŒ‡ä»¤',
    commands: [
      { name: 'ä»htmlåˆå§‹åŒ–åœ°å›¾', desc: 'æ ¹æ® Map.html åˆå§‹åŒ–æ•°æ®åº“åœ°å›¾' },
      { name: 'åˆå§‹åŒ–ä¸–ç•Œ', desc: 'æ‰§è¡Œä¸–ç•Œåˆå§‹åŒ–æµç¨‹' },
      { name: 'å¼ºåˆ¶ä¿®æ”¹å›½å®¶åç§°', desc: 'ç®¡ç†å‘˜å¼ºåˆ¶ä¿®æ”¹å›½å®¶åç§°' },
      { name: 'é‡ç½®ä¸–ç•Œåœ°å›¾', desc: 'é‡ç½®åœ°å›¾æ•°æ®' },
      { name: 'é‡ç½®å›½å®¶æ•°æ®', desc: 'é‡ç½®æ‰€æœ‰å›½å®¶æ•°æ®' },
      { name: 'é‡ç½®ç”¨æˆ·æ•°æ®', desc: 'é‡ç½®æŒ‡å®šç”¨æˆ·æ•°æ®' },
      // { name: 'æ‰‹åŠ¨ç»“ç®—', desc: 'æ‰‹åŠ¨è§¦å‘å°æ—¶ç»“ç®—ï¼ˆè°ƒè¯•ç”¨ï¼‰' }, // å¦‚æœ ManualCheckIn.ts å­˜åœ¨
    ]
  },
  // å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šåˆ†ç±»
];

// ç”Ÿæˆå¸®åŠ©æ–‡æœ¬
function generateHelpMessage(): string {
  let message = 'å¾æˆ˜æ–‡æ¸¸ æŒ‡ä»¤å¸®åŠ©\n\n';
  commandCategories.forEach(category => {
    message += `--- ${category.name} ---\n`;
    category.commands.forEach(cmd => {
      message += `  - \`${cmd.name}${cmd.alias ? ` (${cmd.alias})` : ''}\`: ${cmd.desc}\n`;
    });
    message += '\n'; // åˆ†ç±»ä¹‹é—´çš„ç©ºè¡Œ
  });
  message += 'æç¤ºï¼šéƒ¨åˆ†æŒ‡ä»¤éœ€è¦ç‰¹å®šæƒé™æˆ–èº«ä»½æ‰èƒ½ä½¿ç”¨ã€‚';
  return message;
}

// å°è¯•å‘é€åˆå¹¶è½¬å‘æ¶ˆæ¯çš„å‡½æ•° (éœ€è¦é€‚é…å…·ä½“å¹³å°)
async function sendForwardedHelpMessage(session: Session, title: string, messages: string[]) {
    // æ£€æŸ¥åˆå¹¶è½¬å‘æ–¹æ³•æ˜¯å¦å­˜åœ¨
    const sendForwardFunc = session.bot.internal?.sendGroupForwardMsg || session.bot.internal?.send_group_forward_msg;

    if (!sendForwardFunc) {
        console.warn('[Help Command] Adapter does not support sendGroupForwardMsg. Sending plain text.');
        await session.send(messages.join('\n--------------------\n'));
        return;
    }
    try {
        // æ„å»ºç¬¦åˆé€‚é…å™¨è¦æ±‚çš„æ¶ˆæ¯èŠ‚ç‚¹ (Node) åˆ—è¡¨
        const msgList = messages.map(msg => ({
            // --- ä¿®æ”¹ï¼šä½¿ç”¨ç¬¦åˆ OneBot Node ç»“æ„çš„å­—æ®µ ---
            type: 'node', // æ˜ç¡®æŒ‡å®šç±»å‹ä¸º node
            data: {
                // ä½¿ç”¨ name å­—æ®µ
                name: session.bot.user?.name || 'å¸®åŠ©æ‰‹å†Œ',
                // ä½¿ç”¨ uin å­—æ®µï¼Œç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                uin: String(session.bot.selfId || session.bot.userId || ''),
                // å°†æ¶ˆæ¯æ–‡æœ¬åŒ…è£…åœ¨ content æ•°ç»„ä¸­çš„ text æ¶ˆæ¯æ®µé‡Œ
                content: [
                    { type: 'text', data: { text: msg.replace(/`/g, '') } } // ç§»é™¤åå¼•å·
                ]
                // å¦‚æœéœ€è¦æ—¶é—´æˆ³ï¼Œå¯ä»¥æ·»åŠ  time å­—æ®µ: time: Math.floor(Date.now() / 1000)
            }
            // --- ä¿®æ”¹ç»“æŸ ---
        }));


        // è°ƒç”¨é€‚é…å™¨çš„å†…éƒ¨æ–¹æ³•å‘é€åˆå¹¶è½¬å‘æ¶ˆæ¯
        // æ³¨æ„ï¼šå‚æ•°ç»“æ„å¯èƒ½éœ€è¦è°ƒæ•´ï¼Œè¿™é‡Œå‡è®¾ sendForwardFunc æ¥å— group_id å’Œ messages åˆ—è¡¨
        await sendForwardFunc.call(session.bot.internal, session.guildId, msgList);

    } catch (error) {
        // --- ä¿®æ”¹ï¼šç§»é™¤æ‰€æœ‰å¤‡ç”¨æ–¹æ¡ˆï¼Œåªè®°å½•é”™è¯¯ ---
        // æ— è®ºå‘ç”Ÿä»€ä¹ˆé”™è¯¯ï¼Œéƒ½åªåœ¨æ§åˆ¶å°è®°å½•ï¼Œä¸å‘é€ä»»ä½•å›é€€æ¶ˆæ¯ç»™ç”¨æˆ·
        console.error("å°è¯•å‘é€åˆå¹¶è½¬å‘å¸®åŠ©æ¶ˆæ¯æ—¶å¤±è´¥:", error);
        // ä¸å†å‘é€ session.send(...)
        // --- ä¿®æ”¹ç»“æŸ ---
    }
}


export function HelpCommand(ctx: Context) { // å‡½æ•°åä¿®æ­£ä¸º HelpCommand
  ctx.command('help', 'æ˜¾ç¤ºæŒ‡ä»¤å¸®åŠ©ä¿¡æ¯')
    .alias('å¸®åŠ©', 'èœå•')
    .action(async ({ session }) => {
      if (!session) return;

      const helpTitle = 'ğŸ“œ å¾æˆ˜æ–‡æ¸¸ æŒ‡ä»¤å¸®åŠ© ğŸ“œ';
      const helpMessages: string[] = [];

      commandCategories.forEach(category => {
        let categoryMessage = `--- ${category.name} ---\n`;
        category.commands.forEach(cmd => {
          categoryMessage += `  - \`${cmd.name}${cmd.alias ? ` (${cmd.alias})` : ''}\`: ${cmd.desc}\n`;
        });
        helpMessages.push(categoryMessage.trim());
      });
       helpMessages.push('æç¤ºï¼šéƒ¨åˆ†æŒ‡ä»¤éœ€è¦ç‰¹å®šæƒé™æˆ–èº«ä»½æ‰èƒ½ä½¿ç”¨ã€‚');

      await sendForwardedHelpMessage(session, helpTitle, helpMessages);
    });
}